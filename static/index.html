<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantumPay Payment Race Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-gradient"></script>
    <style>
        :root {
            --primary: #6366F1;
            --primary-light: rgba(99, 102, 241, 0.1);
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --background: #F8FAFC;
            --card: #FFFFFF;
            --text: #0F172A;
            --text-secondary: #64748B;
            --border: #E2E8F0;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --chart-grid: #E2E8F0;
            --chart-text: #64748B;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --gradient-start: #6366F1;
            --gradient-end: #A78BFA;
        }

        [data-theme="dark"] {
            --primary: #818CF8;
            --primary-light: rgba(129, 140, 248, 0.1);
            --background: #0F172A;
            --card: #1E293B;
            --text: #F1F5F9;
            --text-secondary: #94A3B8;
            --border: #334155;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            --chart-grid: #334155;
            --chart-text: #94A3B8;
            --gradient-start: #818CF8;
            --gradient-end: #C4B5FD;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: var(--transition);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 1.5rem;
            width: 100%;
        }

        .navbar {
            background: var(--card);
            padding: 1.25rem 0;
            box-shadow: var(--card-shadow);
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--border);
        }

        .navbar-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
        }

        .title {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.25rem;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .controls {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 0.75rem;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
            background: var(--primary);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .btn:hover::before {
            opacity: 1;
        }

        .btn span {
            position: relative;
            z-index: 1;
        }

        .theme-toggle {
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--text);
        }

        .theme-toggle:hover {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .card {
            background: var(--card);
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .card:hover::before {
            opacity: 1;
        }

        .card-title {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            font-weight: 500;
        }

        .card-value {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .card.best-performer .card-value {
            color: var(--success);
            background: none;
            -webkit-text-fill-color: var(--success);
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-wrapper {
            background: var(--card);
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .chart-wrapper::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
            opacity: 0.02;
            pointer-events: none;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--success);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            display: none;
            animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 50;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            background: var(--card);
            margin: 1rem 0;
            border: 1px solid var(--border);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--danger);
            position: relative;
        }

        .status-indicator.connected {
            background: var(--success);
        }

        .status-indicator.connected::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .footer {
            margin-top: auto;
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            border-top: 1px solid var(--border);
            background: var(--card);
        }

        .dropdown {
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text);
            font-size: 0.875rem;
            cursor: pointer;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }
            70% {
                transform: scale(2);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 0;
            }
        }

        @media (max-width: 768px) {
            .navbar-content {
                flex-direction: column;
                text-align: center;
            }

            .charts-container {
                grid-template-columns: 1fr;
            }

            .controls {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }

            .btn {
                flex: 1;
                justify-content: center;
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
<nav class="navbar">
    <div class="container navbar-content">
        <div>
            <h1 class="title">QuantumPay Payment Race Dashboard</h1>
            <p class="subtitle">Real-time payment gateway performance monitoring</p>
        </div>
        <div class="controls">
            <button class="btn theme-toggle" id="themeToggle">
                <span class="theme-icon">🌞</span>
                <span>Theme</span>
            </button>
            <button class="btn" id="resetBtn">
                <span>↺</span>
                <span>Reset</span>
            </button>
            <button class="btn" id="downloadBtn">
                <span>↓</span>
                <span>Download Report</span>
            </button>
        </div>
    </div>
</nav>

<div class="container">
    <div class="connection-status">
        <div class="status-indicator" id="statusIndicator"></div>
        <span id="statusText">Connecting to gateway...</span>
    </div>

    <div class="cards-grid">
        <div class="card">
            <div class="card-title">Total Transactions</div>
            <div class="card-value" id="totalTransactions">0</div>
        </div>
        <div class="card">
            <div class="card-title">Total Savings</div>
            <div class="card-value" id="totalSavings">$0.00</div>
        </div>
        <div class="card">
            <div class="card-title">Best Performer</div>
            <div class="card-value" id="bestPerformer">-</div>
        </div>
    </div>

    <div class="charts-container">
        <div class="chart-wrapper">
            <canvas id="winsChart"></canvas>
        </div>
        <div class="chart-wrapper">
            <canvas id="savingsChart"></canvas>
        </div>
        <div class="chart-wrapper">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="font-size: 1rem; font-weight: 500;">Fee Forecast</h3>
                <select id="forecastPeriod" class="dropdown">
                    <option value="1month">1 Month</option>
                    <option value="3month" selected>3 Months</option>
                    <option value="6month">6 Months</option>
                </select>
            </div>
            <canvas id="forecastChart"></canvas>
        </div>
    </div>

    <div class="toast" id="toast"></div>
</div>

<footer class="footer">
    <p>QuantumPay Dashboard v1.0.0 | © 2024 QuantumPay</p>
</footer>

<script>
    // Theme handling
    const themeToggle = document.getElementById('themeToggle');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    let isDarkMode = prefersDark;

    function setTheme(isDark) {
        isDarkMode = isDark;
        document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
        themeToggle.querySelector('.theme-icon').textContent = isDark ? '🌜' : '🌞';

        const textColor = isDark ? '#94A3B8' : '#64748B';
        const gridColor = isDark ? '#334155' : '#E2E8F0';

        const chartConfig = {
            scales: {
                x: {grid: {color: gridColor}, ticks: {color: textColor}},
                y: {grid: {color: gridColor}, ticks: {color: textColor}}
            },
            plugins: {legend: {labels: {color: textColor}}}
        };

        winsChart.options.scales = chartConfig.scales;
        winsChart.options.plugins.legend = chartConfig.plugins.legend;
        winsChart.data.datasets[0].backgroundColor = isDark
            ? ['#34D399', '#818CF8', '#FBBF24']
            : ['#10B981', '#6366F1', '#F59E0B'];
        winsChart.update();

        savingsChart.options.scales = chartConfig.scales;
        savingsChart.options.plugins.legend = chartConfig.plugins.legend;
        savingsChart.data.datasets[0].borderColor = isDark ? '#818CF8' : '#6366F1';
        savingsChart.data.datasets[0].backgroundColor = isDark
            ? Chart.helpers.color('#818CF8').alpha(0.1).rgbString()
            : Chart.helpers.color('#6366F1').alpha(0.1).rgbString();
        savingsChart.update();

        forecastChart.options.scales = chartConfig.scales;
        forecastChart.options.plugins.legend = chartConfig.plugins.legend;
        forecastChart.data.datasets.forEach(dataset => {
            dataset.borderColor = isDark ? dataset.borderColor.replace('6366F1', '818CF8') : dataset.borderColor.replace('818CF8', '6366F1');
            dataset.backgroundColor = isDark
                ? Chart.helpers.color(dataset.borderColor).alpha(0.1).rgbString()
                : Chart.helpers.color(dataset.borderColor).alpha(0.1).rgbString();
        });
        forecastChart.update();
    }

    // Toast notifications
    const toastQueue = [];
    let isToastShowing = false;

    function showToast(message, type = 'success') {
        toastQueue.push({message, type});

        if (!isToastShowing) {
            displayNextToast();
        }
    }

    function displayNextToast() {
        if (toastQueue.length === 0) {
            isToastShowing = false;
            return;
        }

        isToastShowing = true;
        const {message, type} = toastQueue.shift();
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.display = 'block';
        toast.style.background = type === 'success' ? 'var(--success)' : 'var(--danger)';
        setTimeout(() => {
            toast.style.display = 'none';
            displayNextToast();
        }, 2000);
    }

    // Chart initialization
    const chartOptions = {
        responsive: true,
        animation: {duration: 750, easing: 'easeInOutQuart'},
        plugins: {
            legend: {
                display: true,
                position: 'top',
                labels: {
                    padding: 20,
                    usePointStyle: true,
                    pointStyle: 'circle',
                    font: {family: 'Inter', size: 12, weight: '500'}
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: '#ffffff',
                bodyColor: '#ffffff',
                borderColor: 'rgba(255, 255, 255, 0.2)',
                borderWidth: 1,
                padding: 12,
                cornerRadius: 8,
                titleFont: {family: 'Inter', size: 14, weight: '600'},
                bodyFont: {family: 'Inter', size: 12},
                displayColors: false,
                callbacks: {
                    label: function (context) {
                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        if (context.parsed.y !== null) {
                            const value = context.parsed.y.toFixed(2);
                            // Add % only for "Fee Forecast" datasets
                            if (['Stripe', 'PayPal', 'Square'].includes(context.dataset.label)) {
                                label += value + '%';
                            } else {
                                label += value;
                            }
                        }
                        return label;
                    }
                }
            }
        }
    };

    const winsChart = new Chart(document.getElementById('winsChart'), {
        type: 'bar',
        data: {
            labels: ['Stripe', 'PayPal', 'Square'],
            datasets: [{
                label: 'Gateway Wins',
                data: [0, 0, 0],
                backgroundColor: ['#10B981', '#6366F1', '#F59E0B'],
                borderRadius: 12,
                borderSkipped: false,
                barThickness: 40
            }]
        },
        options: {
            ...chartOptions,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {drawBorder: false, color: 'var(--chart-grid)', lineWidth: 0.5},
                    ticks: {color: 'var(--chart-text)', font: {family: 'Inter', size: 12}, padding: 10},
                    title: {
                        display: true,
                        text: 'Number of Wins',
                        color: 'var(--text)',
                        font: {family: 'Inter', size: 12, weight: '500'},
                        padding: {bottom: 20}
                    }
                },
                x: {
                    grid: {display: false},
                    ticks: {color: 'var(--chart-text)', font: {family: 'Inter', size: 12}}
                }
            }
        }
    });

    const savingsChart = new Chart(document.getElementById('savingsChart'), {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Cumulative Savings ($)',
                data: [],
                borderColor: '#6366F1',
                backgroundColor: Chart.helpers.color('#6366F1').alpha(0.1).rgbString(),
                tension: 0.4,
                fill: true,
                pointBackgroundColor: '#6366F1',
                pointBorderColor: '#FFFFFF',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6,
                borderWidth: 3
            }]
        },
        options: {
            ...chartOptions,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {color: 'var(--chart-grid)', lineWidth: 0.5},
                    ticks: {
                        color: 'var(--chart-text)',
                        font: {family: 'Inter', size: 12},
                        padding: 10,
                        callback: function (value) {
                            return '$' + value.toFixed(2);
                        }
                    },
                    title: {
                        display: true,
                        text: 'Total Savings ($)',
                        color: 'var(--text)',
                        font: {family: 'Inter', size: 12, weight: '500'},
                        padding: {bottom: 20}
                    }
                },
                x: {
                    grid: {display: false},
                    ticks: {color: 'var(--chart-text)', font: {family: 'Inter', size: 12}}
                }
            }
        }
    });

    const forecastChart = new Chart(document.getElementById('forecastChart'), {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Stripe',
                    data: [],
                    borderColor: '#10B981',
                    backgroundColor: Chart.helpers.color('#10B981').alpha(0.1).rgbString(),
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#10B981',
                    pointBorderColor: '#FFFFFF',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    borderWidth: 3
                },
                {
                    label: 'PayPal',
                    data: [],
                    borderColor: '#6366F1',
                    backgroundColor: Chart.helpers.color('#6366F1').alpha(0.1).rgbString(),
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#6366F1',
                    pointBorderColor: '#FFFFFF',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    borderWidth: 3
                },
                {
                    label: 'Square',
                    data: [],
                    borderColor: '#F59E0B',
                    backgroundColor: Chart.helpers.color('#F59E0B').alpha(0.1).rgbString(),
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#F59E0B',
                    pointBorderColor: '#FFFFFF',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    borderWidth: 3
                }
            ]
        },
        options: {
            ...chartOptions,
            scales: {
                y: {
                    beginAtZero: false,
                    grid: {color: 'var(--chart-grid)', lineWidth: 0.5},
                    ticks: {
                        color: 'var(--chart-text)',
                        font: {family: 'Inter', size: 12},
                        padding: 10,
                        callback: function (value) {
                            return value.toFixed(2) + '%';
                        }
                    },
                    title: {
                        display: true,
                        text: 'Fee Rate (%)',
                        color: 'var(--text)',
                        font: {family: 'Inter', size: 12, weight: '500'},
                        padding: {bottom: 20}
                    }
                },
                x: {
                    grid: {display: false},
                    ticks: {color: 'var(--chart-text)', font: {family: 'Inter', size: 12}}
                }
            }
        }
    });

    // Initialize theme
    setTheme(isDarkMode);

    // Theme toggle event listener
    themeToggle.addEventListener('click', () => {
        setTheme(!isDarkMode);
    });

    // Data state
    let winsData = {Stripe: 0, PayPal: 0, Square: 0};
    let totalSavings = 0;
    let transactionCount = 0;

    // WebSocket connection
    const ws = new WebSocket('ws://localhost:8000/ws');
    const statusIndicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');

    function updateConnectionStatus(connected) {
        statusIndicator.classList.toggle('connected', connected);
        statusText.textContent = connected ? 'Connected to gateway' : 'Disconnected from gateway';
    }

    ws.onopen = () => {
        updateConnectionStatus(true);
        loadInitialData();
        loadForecastData();
    };

    ws.onclose = () => {
        updateConnectionStatus(false);
        showToast('Connection lost. Attempting to reconnect...', 'error');
    };

    // Load forecast data
    async function loadForecastData(period = '3month') {
        try {
            const response = await fetch(`http://localhost:8000/forecast?period=${period}`);
            const data = await response.json();

            forecastChart.data.labels = data.labels;
            forecastChart.data.datasets[0].data = data.Stripe;
            forecastChart.data.datasets[1].data = data.PayPal;
            forecastChart.data.datasets[2].data = data.Square;
            forecastChart.update('show');

            showToast('Fee forecast loaded successfully');
        } catch (error) {
            console.error('Error loading forecast data:', error);
            showToast('Failed to load fee forecast', 'error');
        }
    }

    // Forecast period dropdown
    document.getElementById('forecastPeriod').addEventListener('change', (event) => {
        loadForecastData(event.target.value);
    });

    // Data handling
    async function loadInitialData() {
        try {
            const response = await fetch('http://localhost:8000/dashboard-data');
            const data = await response.json();

            winsData = {
                Stripe: data.summary['Stripe Wins'] || 0,
                PayPal: data.summary['PayPal Wins'] || 0,
                Square: data.summary['Square Wins'] || 0
            };
            totalSavings = data.transactions?.reduce((sum, tx) => sum + (tx.savings || 0), 0) || 0;
            transactionCount = data.transactions?.length || 0;

            savingsChart.data.labels = data.transactions?.map(tx => `T${tx.transaction}`) || [];
            savingsChart.data.datasets[0].data = data.transactions?.reduce((acc, tx) => {
                const last = acc.length ? acc[acc.length - 1] : 0;
                acc.push(last + (tx.savings || 0));
                return acc;
            }, []) || [];

            updateCharts();
            updateSummaryCards();
            showToast('Dashboard data loaded successfully');
        } catch (error) {
            console.error('Error loading initial data:', error);
            showToast('Failed to load initial data', 'error');
        }
    }

    function updateCharts() {
        winsChart.data.datasets[0].data = [
            winsData.Stripe,
            winsData.PayPal,
            winsData.Square
        ];
        winsChart.update('show');

        if (savingsChart.data.labels.length > 20) {
            savingsChart.data.labels.shift();
            savingsChart.data.datasets[0].data.shift();
        }
        savingsChart.update('show');
    }

    function updateSummaryCards() {
        document.getElementById('totalTransactions').textContent = transactionCount;
        document.getElementById('totalSavings').textContent = formatCurrency(totalSavings);

        const bestPerformer = Object.entries(winsData).reduce((a, b) =>
            b[1] > a[1] ? b : a, ['None', 0])[0];
        const bestPerformerElement = document.getElementById('bestPerformer');
        bestPerformerElement.textContent = bestPerformer;
        bestPerformerElement.parentElement.classList.toggle('best-performer', bestPerformer !== 'None');
    }

    function formatCurrency(amount) {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(amount);
    }

    ws.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);

            if (data.winner && data.savings !== undefined) {
                const normalizedWinner = data.winner.charAt(0).toUpperCase() + data.winner.slice(1).toLowerCase();
                const winner = normalizedWinner === "Paypal" ? "PayPal" : normalizedWinner;
                if (winsData.hasOwnProperty(winner)) {
                    winsData[winner]++;
                    totalSavings += data.savings;
                    transactionCount++;

                    savingsChart.data.labels.push(`T${transactionCount}`);
                    savingsChart.data.datasets[0].data.push(totalSavings);

                    showToast(`New transaction: ${winner} won! Saved ${formatCurrency(data.savings)}`);
                } else {
                    console.error("Unknown winner:", winner);
                }
            }

            setTimeout(() => {
                updateCharts();
                updateSummaryCards();
            }, 0);
        } catch (error) {
            console.error('Error processing WebSocket message:', error);
            showToast('Error processing update', 'error');
        }
    };

    document.getElementById('downloadBtn').addEventListener('click', () => {
        const report = {
            timestamp: new Date().toISOString(),
            totalTransactions: transactionCount,
            totalSavings,
            gatewayWins: winsData,
            savingsHistory: savingsChart.data.datasets[0].data,
            forecast: {
                labels: forecastChart.data.labels,
                Stripe: forecastChart.data.datasets[0].data,
                PayPal: forecastChart.data.datasets[1].data,
                Square: forecastChart.data.datasets[2].data
            }
        };

        const blob = new Blob([JSON.stringify(report, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `quantumpay-report-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast('Report downloaded successfully');
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
        if (ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({type: 'reset'}));
        } else {
            showToast('Cannot reset: WebSocket disconnected', 'error');
        }
    });
</script>
</body>
</html>